<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>颱風訊息整合網</title>
    <!-- 這是小秋的颱風網頁，最終更新測試 -->
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 自定義滾動條樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- 網頁標頭區塊 -->
    <header class="bg-blue-700 text-white p-4 shadow-md flex flex-col md:flex-row items-center justify-between rounded-b-lg">
        <!-- 網站名稱 -->
        <div class="text-3xl font-bold mb-4 md:mb-0 md:mr-auto">
            颱風訊息整合網
        </div>
        <!-- 其他功能按鈕 -->
        <nav class="flex flex-wrap justify-center md:justify-end gap-3">
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                最新消息
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                歷史資料
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                防災資訊
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                關於我們
            </button>
        </nav>
    </header>

    <!-- 主要內容區塊 -->
    <main class="flex flex-1 flex-col lg:flex-row p-4 gap-4">
        <!-- 左側颱風列表 -->
        <aside class="w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md overflow-hidden flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">目前颱風列表</h2>
            <div id="typhoon-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="text-gray-500 text-center py-10" id="typhoon-list-loading">
                    載入颱風資料中...
                </div>
                <!-- 颱風項目將由 JavaScript 動態載入 -->
            </div>
        </aside>

        <!-- 中右側颱風詳細資訊 -->
        <section class="w-full lg:w-3/4 bg-white p-6 rounded-lg shadow-md overflow-hidden flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">颱風詳細資訊</h2>
            <div id="typhoon-details-content" class="flex-1 overflow-y-auto custom-scrollbar">
                <div id="typhoon-details-placeholder" class="text-gray-500 text-center py-10">
                    請從左側列表選擇一個颱風以查看其詳細資訊。
                </div>
                <div id="typhoon-details-loading" class="text-gray-500 text-center py-10 hidden">
                    載入颱風詳細資訊中...
                </div>
                <!-- 颱風詳細資訊將由 JavaScript 動態載入 -->
            </div>

            <!-- 風場預報地圖 iframe -->
            <div id="wind-map-container" class="mt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">風場預報地圖</h4>
                <div class="relative w-full h-[400px] bg-gray-200 rounded-lg overflow-hidden shadow-sm flex items-center justify-center">
                    <iframe id="wind-map-iframe" class="absolute inset-0 w-full h-full rounded-lg hidden" frameborder="0" allowfullscreen></iframe>
                    <p id="wind-map-loading" class="absolute text-gray-500">載入風場預報中...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // **重要：這裡設定為您在 Vercel 部署的代理伺服器完整網址**
        // 請將 'https://typhoon-proxy-server.vercel.app' 替換為您實際在 Vercel 得到的網址！
        const CWA_TYPHOON_API_URL = 'https://typhoon-proxy-server.vercel.app/get-typhoon-data';
        
        // 風場預報顯示系統 API 基礎 URL
        const WIND_MAP_BASE_URL = 'https://www.twipcam.com/api/v1/map/wind';

        // 用來儲存從 API 獲取的颱風資料，方便點擊時快速查找
        let typhoonDataMap = new Map();

        // 載入預設地圖 (台灣中心) 的函數
        function loadDefaultMap() {
            const defaultLat = 23.5; // 台灣中心緯度
            const defaultLon = 121;  // 台灣中心經度
            const defaultZoom = 5;   // 預設地圖縮放程度
            const defaultMapSrc = `${WIND_MAP_BASE_URL}?lat=${defaultLat}&lon=${defaultLon}&zoom=${defaultZoom}`;
            const windMapIframe = document.getElementById('wind-map-iframe');
            const windMapLoading = document.getElementById('wind-map-loading');

            windMapIframe.src = defaultMapSrc;
            windMapLoading.classList.remove('hidden'); // 顯示載入提示
            windMapIframe.classList.add('hidden'); // 隱藏 iframe 直到載入完成
        }

        // 顯示颱風詳細資訊的函數
        function displayTyphoonDetails(typhoonId) {
            const typhoonDetailsContent = document.getElementById('typhoon-details-content');
            const typhoonDetailsPlaceholder = document.getElementById('typhoon-details-placeholder');
            const typhoonDetailsLoading = document.getElementById('typhoon-details-loading');
            const windMapIframe = document.getElementById('wind-map-iframe');
            const windMapLoading = document.getElementById('wind-map-loading');

            // 顯示載入提示，隱藏佔位符
            typhoonDetailsPlaceholder.classList.add('hidden');
            typhoonDetailsLoading.classList.remove('hidden');
            typhoonDetailsContent.innerHTML = ''; // 清空舊內容

            const typhoon = typhoonDataMap.get(typhoonId);

            if (typhoon) {
                // 隱藏載入提示
                typhoonDetailsLoading.classList.add('hidden');

                // 解析颱風名稱和警報內容 (根據 W-C0034-005 可能的結構調整)
                // W-C0034-005 可能的結構是 records.TropicalCyclone[].TCName, records.TropicalCyclone[].TCID, records.TropicalCyclone[].ReportTime
                const typhoonName = typhoon.TCName || typhoon.typhoonName || '未知颱風';
                const issueTime = typhoon.ReportTime || typhoon.issueTime || '無發布時間';
                let alertContent = '無詳細警報內容。'; // W-C0034-005 可能不包含詳細警報內容

                // 嘗試從 W-C0034-005 的結構中尋找座標
                let lat = 23.5; // 預設台灣中心
                let lon = 121;
                let zoom = 5;

                // 假設座標可能在 typhoon.Location.Lat 和 typhoon.Location.Lon
                if (typhoon.Location && typhoon.Location.Lat && typhoon.Location.Lon) {
                    lat = parseFloat(typhoon.Location.Lat);
                    lon = parseFloat(typhoon.Location.Lon);
                    zoom = 7; // 如果有精確座標，放大地圖
                } else if (typhoon.lat && typhoon.lon) { // 兼容舊結構
                    lat = parseFloat(typhoon.lat);
                    lon = parseFloat(typhoon.lon);
                    zoom = 7;
                } else {
                    console.warn(`未能在颱風 ${typhoonName} 的資料中找到明確座標，將使用預設地圖中心。`);
                }

                // 動態生成詳細資訊 HTML
                const detailsHtml = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">${typhoonName}</h3>
                    <p class="text-gray-600 mb-2"><span class="font-semibold">發布時間:</span> ${issueTime}</p>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-800 mb-2">颱風概況</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${alertContent}</p>
                        <p class="text-gray-700 mt-2">目前中心緯度: ${lat.toFixed(2)} 經度: ${lon.toFixed(2)}</p>
                        <!-- 更多 W-C0034-005 可能的欄位可以根據實際 API 回應添加 -->
                        <p class="text-gray-600 mt-4"><span class="font-semibold">目前強度:</span> 資料暫無提供</p>
                        <p class="text-gray-600"><span class="font-semibold">近中心最大風速:</span> 資料暫無提供</p>
                        <p class="text-gray-600"><span class="font-semibold">七級風暴風半徑:</span> 資料暫無提供</p>
                        <p class="text-gray-600"><span class="font-semibold">預計路徑:</span> 資料暫無提供</p>
                    </div>
                `;
                typhoonDetailsContent.innerHTML = detailsHtml;

                // 更新風場預報地圖的 iframe 來源
                const mapSrc = `${WIND_MAP_BASE_URL}?lat=${lat}&lon=${lon}&zoom=${zoom}`;
                windMapIframe.src = mapSrc;
                windMapLoading.classList.remove('hidden'); // 顯示載入提示
                windMapIframe.classList.add('hidden'); // 隱藏 iframe 直到載入完成

            } else {
                // 如果找不到颱風資料，顯示錯誤訊息
                typhoonDetailsLoading.classList.add('hidden');
                typhoonDetailsContent.innerHTML = `
                    <div class="text-red-500 text-center py-10">
                        找不到颱風 ${typhoonId} 的詳細資訊。
                    </div>
                `;
                // 載入預設地圖
                loadDefaultMap();
            }
        }

        // 渲染颱風列表的函數
        function renderTyphoonList(typhoons) {
            const typhoonListDiv = document.getElementById('typhoon-list');
            const typhoonListLoading = document.getElementById('typhoon-list-loading');
            typhoonListDiv.innerHTML = ''; // 清空現有列表
            typhoonListLoading.classList.add('hidden'); // 隱藏載入提示

            if (typhoons && typhoons.length > 0) {
                typhoons.forEach(typhoon => {
                    // 從 API 資料中提取所需資訊 (根據 W-C0034-005 可能的結構調整)
                    const typhoonId = typhoon.TCID || typhoon.identifier; // 使用 TCID 或 identifier 作為唯一 ID
                    const typhoonName = typhoon.TCName || typhoon.typhoonName || '未知颱風';
                    const issueTime = typhoon.ReportTime ? new Date(typhoon.ReportTime).toLocaleString() : (typhoon.issueTime ? new Date(typhoon.issueTime).toLocaleString() : '無發布時間');

                    // 將完整的颱風資料儲存起來，方便後續點擊時使用
                    typhoonDataMap.set(typhoonId, typhoon);

                    const typhoonItem = document.createElement('div');
                    typhoonItem.classList.add(
                        'typhoon-item', 'p-3', 'mb-2', 'bg-gray-50', 'hover:bg-blue-100',
                        'rounded-lg', 'cursor-pointer', 'transition', 'duration-200', 'ease-in-out'
                    );
                    typhoonItem.dataset.typhoonId = typhoonId;
                    
                    typhoonItem.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-700">${typhoonName}</h3>
                        <p class="text-sm text-gray-500">發布時間: ${issueTime}</p>
                    `;

                    typhoonItem.addEventListener('click', () => {
                        // 移除所有颱風項目的 active 樣式
                        document.querySelectorAll('.typhoon-item').forEach(item => {
                            item.classList.remove('bg-blue-200', 'border-l-4', 'border-blue-500');
                        });
                        // 為當前點擊的颱風項目添加 active 樣式
                        typhoonItem.classList.add('bg-blue-200', 'border-l-4', 'border-blue-500');

                        displayTyphoonDetails(typhoonId);
                    });
                    typhoonListDiv.appendChild(typhoonItem);
                });
            } else {
                typhoonListDiv.innerHTML = `
                    <div class="text-gray-500 text-center py-10">
                        目前無颱風警報資料。
                    </div>
                `;
            }
        }

        // 從代理伺服器獲取颱風資料的函數
        async function fetchTyphoonData() {
            const typhoonListLoading = document.getElementById('typhoon-list-loading');
            typhoonListLoading.classList.remove('hidden'); // 顯示載入提示

            try {
                // 向您部署的代理伺服器發送請求
                const response = await fetch(CWA_TYPHOON_API_URL, {
                    method: 'GET',
                });

                // 輸出完整的 Response 物件到控制台，以便偵錯
                console.log('Proxy API Response Object:', response);

                if (!response.ok) {
                    // 如果 HTTP 狀態碼不是 2xx，拋出錯誤
                    const errorText = await response.text(); // 嘗試讀取錯誤訊息
                    console.error(`Proxy HTTP 錯誤! 狀態碼: ${response.status}, 狀態文字: ${response.statusText}, 回應內容: ${errorText}`);
                    throw new Error(`Proxy HTTP 錯誤! 狀態碼: ${response.status}, 訊息: ${response.statusText || '未知錯誤'}`);
                }

                const data = await response.json();

                // **新的資料解析邏輯 (根據 W-C0034-005 可能的結構調整)**
                // W-C0034-005 的資料可能在 data.records.TropicalCyclone 陣列中
                let typhoons = [];
                if (data.records && data.records.TropicalCyclone && Array.isArray(data.records.TropicalCyclone)) {
                    typhoons = data.records.TropicalCyclone;
                } else {
                    // 如果不是預期的結構，記錄錯誤並顯示訊息
                    console.error('API 回應資料結構不符預期 (W-C0034-005):', data);
                    document.getElementById('typhoon-list').innerHTML = `
                        <div class="text-red-500 text-center py-10">
                            無法解析颱風資料，請檢查 API 回應結構。
                        </div>
                    `;
                    return; // 停止執行
                }

                if (typhoons.length > 0) {
                    renderTyphoonList(typhoons);
                } else {
                    document.getElementById('typhoon-list').innerHTML = `
                        <div class="text-gray-500 text-center py-10">
                            目前無颱風警報資料。
                        </div>
                    `;
                }

            } catch (error) {
                console.error('獲取颱風資料失敗:', error); // 輸出完整的錯誤物件
                let errorMessage = '載入颱風資料失敗。';
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    errorMessage += '可能是網路連線問題，或您的代理伺服器無法存取。';
                } else {
                    errorMessage += `錯誤訊息: ${error.message}。請檢查代理伺服器狀態。`;
                }
                document.getElementById('typhoon-list').innerHTML = `
                    <div class="text-red-500 text-center py-10">
                        ${errorMessage}
                    </div>
                `;
            } finally {
                typhoonListLoading.classList.add('hidden'); // 無論成功或失敗都隱藏載入提示
            }
        }

        // 網頁載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {
            loadDefaultMap(); // 初始載入預設地圖
            fetchTyphoonData(); // 獲取颱風資料
        });
    </script>
</body>
</html>
