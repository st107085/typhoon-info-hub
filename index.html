<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>颱風訊息整合網</title>
    <!-- 這是小秋的颱風網頁，最終確認更新 - 2025年7月18日 - 版本 20250718090000 -->
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzxH+iQ/Y5kLfNDuXiUNGpZhFmY="
     crossorigin=""/>
    <style>
        /* 設定 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 自定義滾動條樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* 針對 iframe 使用 opacity 隱藏，確保其有佈局尺寸 */
        .wind-map-iframe-hidden {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .wind-map-iframe-visible {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        /* 自定義國際地圖容器樣式 */
        #custom-typhoon-map {
            width: 100%;
            height: 500px; /* 預設高度，可根據需要調整 */
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            /* 移除 display: flex; align-items: center; justify-content: center; */
            /* 讓 Leaflet 接管地圖顯示 */
            color: #6b7280; /* text-gray-500 */
            font-size: 1.125rem; /* text-lg */
        }
        /* Leaflet 地圖載入時的提示 */
        #custom-typhoon-map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* 確保在地圖上方 */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            color: #4b5563; /* text-gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- 網頁標頭區塊 -->
    <header class="bg-blue-700 text-white p-4 shadow-md flex flex-col md:flex-row items-center justify-between rounded-b-lg">
        <!-- 網站名稱 -->
        <div class="text-3xl font-bold mb-4 md:mb-0 md:mr-auto">
            颱風訊息整合網
        </div>
        <!-- 其他功能按鈕 -->
        <nav class="flex flex-wrap justify-center md:justify-end gap-3">
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                最新消息
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                歷史資料
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                防災資訊
            </button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                關於我們
            </button>
        </nav>
    </header>

    <!-- 主要內容區塊 -->
    <main class="flex flex-1 flex-col lg:flex-row p-4 gap-4">
        <!-- 左側颱風列表 -->
        <aside class="w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md overflow-hidden flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">目前颱風列表</h2>
            <!-- 將載入提示移到 typhoon-list 外部，確保它不會被清空 -->
            <div id="typhoon-list-loading" class="text-gray-500 text-center py-10">
                載入颱風資料中...
            </div>
            <div id="typhoon-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- 颱風項目將由 JavaScript 動態載入 -->
            </div>
        </aside>

        <!-- 中右側颱風詳細資訊 -->
        <section class="w-full lg:w-3/4 bg-white p-6 rounded-lg shadow-md overflow-hidden flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">颱風詳細資訊</h2>
            <!-- 將載入提示和佔位符移到 typhoon-details-content 外部 -->
            <div id="typhoon-details-placeholder" class="text-gray-500 text-center py-10">
                請從左側列表選擇一個颱風以查看其詳細資訊。
            </div>
            <div id="typhoon-details-loading" class="text-gray-500 text-center py-10 hidden">
                載入颱風詳細資訊中...
            </div>
            <div id="typhoon-details-content" class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- 颱風詳細資訊將由 JavaScript 動態載入 -->
            </div>

            <!-- 風場預報地圖 iframe -->
            <div id="wind-map-container" class="mt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">風場預報地圖 (台灣周邊)</h4>
                <div class="relative w-full h-[400px] bg-gray-200 rounded-lg overflow-hidden shadow-sm flex items-center justify-center">
                    <!-- 移除 hidden class，改用 opacity 控制顯示 -->
                    <iframe id="wind-map-iframe" class="absolute inset-0 w-full h-full rounded-lg wind-map-iframe-hidden" frameborder="0" allowfullscreen></iframe>
                    <p id="wind-map-loading" class="absolute text-gray-500">載入風場預報中...</p>
                </div>
            </div>

            <!-- 新增各國颱風路徑預測圖區塊 (自定義繪製) -->
            <div id="international-maps-container" class="mt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-2">各國颱風路徑預測圖 (NSTC)</h4>
                <div class="relative">
                    <div id="custom-typhoon-map">
                        <!-- Leaflet 地圖將在這裡初始化 -->
                    </div>
                    <div id="custom-typhoon-map-loading" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-80 rounded-lg">
                        載入國際颱風路徑圖中...
                    </div>
                </div>
            </div>

            <!-- 新增氣象特報區塊 (已從 aside 移動到這裡) -->
            <h2 class="text-2xl font-bold mt-6 mb-4 text-gray-800 border-b pb-2">最新氣象特報</h2>
            <div id="cwa-warnings-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <div id="cwa-warnings-loading" class="text-gray-500 text-center py-10">
                    載入特報資訊中...
                </div>
                <!-- 氣象特報分類專區 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-red-600 mb-2">豪(大)雨特報</h3>
                        <div id="heavy-rain-warnings" class="min-h-[50px] text-gray-500">
                            <!-- 豪(大)雨特報將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">濃霧特報</h3>
                        <div id="dense-fog-warnings" class="min-h-[50px] text-gray-500">
                            <!-- 濃霧特報將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-orange-600 mb-2">高溫特報</h3>
                        <div id="high-temp-warnings" class="min-h-[50px] text-gray-500">
                            <!-- 高溫特報將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-purple-600 mb-2">強風特報</h3>
                        <div id="strong-wind-warnings" class="min-h-[50px] text-gray-500">
                            <!-- 強風特報將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-green-600 mb-2">大雷雨特報</h3>
                        <div id="thunderstorm-warnings" class="min-h-[50px] text-gray-500">
                            <!-- 大雷雨特報將由 JavaScript 動態載入 -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 載入 Leaflet JavaScript - 移到 body 底部，確保在自訂腳本前載入 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // **重要：這裡設定為您在 Vercel 部署的代理伺服器完整網址**
        const PROXY_BASE_URL = 'https://typhoon-proxy-server-new.vercel.app'; 
        const CWA_TYPHOON_API_URL = `${PROXY_BASE_URL}/get-typhoon-data`;
        const CWA_WARNINGS_API_URL = `${PROXY_BASE_URL}/get-cwa-warnings`; 
        const INTERNATIONAL_TYPHOON_API_URL = `${PROXY_BASE_URL}/get-international-typhoon-data`; // 新增國際颱風資料 API 端點
        
        // 風場預報顯示系統 API 基礎 URL
        const WIND_MAP_BASE_URL = 'https://www.twipcam.com/api/v1/map/wind';

        // 用來儲存從 API 獲取的颱風資料，方便點擊時快速查找
        let typhoonDataMap = new Map();

        // Leaflet 地圖實例
        let internationalTyphoonMap = null;
        let pathLayers = []; // 用來儲存地圖上的路徑圖層，方便清除

        // 載入預設地圖 (台灣中心) 的函數
        function loadDefaultMap() {
            const defaultLat = 23.5; // 台灣中心緯度
            const defaultLon = 121;  // 台灣中心經度
            const defaultZoom = 5;   // 預設地圖縮放程度
            const defaultMapSrc = `${WIND_MAP_BASE_URL}?lat=${defaultLat}&lon=${defaultLon}&zoom=${defaultZoom}`;
            const windMapIframe = document.getElementById('wind-map-iframe');
            const windMapLoading = document.getElementById('wind-map-loading');

            windMapIframe.src = defaultMapSrc;
            windMapLoading.classList.remove('hidden'); // 顯示載入提示
            windMapIframe.classList.remove('wind-map-iframe-visible'); // 確保隱藏
            windMapIframe.classList.add('wind-map-iframe-hidden'); // 確保隱藏
        }

        // 輔助函數：將駝峰式命名的 key 轉換為更易讀的格式
        function formatKeyName(key) {
            const translations = {
                'fixTime': '分析時間',
                'coordinate': '座標',
                'maxGustSpeed': '最大陣風速度',
                'maxWindSpeed': '最大風速',
                'movingPrediction': '移動預測',
                'pressure': '中心氣壓',
                'circleOf15Ms': '15米/秒風圈半徑',
                'movingDirection': '移動方向',
                'movingSpeed': '移動速度',
                'radiusOf70PercentProbability': '70%機率半徑',
                'tau': '預報時效 (小時)',
                'initTime': '初始時間',
                'stateTransfers': '狀態轉換',
                'circleOf7Bft': '七級風暴風半徑', 
                'circleOf10Bft': '十級風暴風半徑' 
            };
            return translations[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        }


        // 顯示颱風詳細資訊的函數
        function displayTyphoonDetails(typhoonId) {
            const typhoonDetailsContent = document.getElementById('typhoon-details-content');
            const typhoonDetailsPlaceholder = document.getElementById('typhoon-details-placeholder');
            const typhoonDetailsLoading = document.getElementById('typhoon-details-loading');
            const windMapIframe = document.getElementById('wind-map-iframe');
            const windMapLoading = document.getElementById('wind-map-loading');

            // 顯示載入提示，隱藏佔位符 (增加 null 檢查)
            if (typhoonDetailsPlaceholder) {
                typhoonDetailsPlaceholder.classList.add('hidden');
            }
            if (typhoonDetailsLoading) {
                typhoonDetailsLoading.classList.remove('hidden');
            }
            typhoonDetailsContent.innerHTML = ''; // 清空舊內容

            const typhoon = typhoonDataMap.get(typhoonId);

            if (typhoon) {
                // 隱藏載入提示
                if (typhoonDetailsLoading) { // 增加 null 檢查
                    typhoonDetailsLoading.classList.add('hidden');
                }

                // 解析颱風名稱和警報內容 (根據 W-C0034-005 實際結構調整)
                const typhoonName = typhoon.cwaTyphoonName || typhoon.typhoonName || '未知颱風';
                
                // 獲取最新的分析數據點
                const latestAnalysis = typhoon.analysisData && typhoon.analysisData.fix && typhoon.analysisData.fix.length > 0
                                       ? typhoon.analysisData.fix[typhoon.analysisData.fix.length - 1]
                                       : null;

                const issueTime = latestAnalysis ? new Date(latestAnalysis.fixTime).toLocaleString() : '無發布時間';
                
                // 嘗試從 analysisData.fix 中尋找座標
                let lat = 23.5; // 預設台灣中心
                let lon = 121;
                let zoom = 5;

                if (latestAnalysis && latestAnalysis.coordinate) {
                    const coords = latestAnalysis.coordinate.split(',');
                    if (coords.length === 2) {
                        lon = parseFloat(coords[0]); // 經度 (Lon) 是第一個
                        lat = parseFloat(coords[1]); // 緯度 (Lat) 是第二個
                        zoom = 7; // 如果有精確座標，放大地圖
                    }
                } else {
                    console.warn(`未能在颱風 ${typhoonName} 的資料中找到明確座標，將使用預設地圖中心。`);
                }

                // ***偵錯訊息開始***
                console.log(`Debug: Typhoon ID: ${typhoonId}`);
                console.log('Debug: Latest Analysis:', latestAnalysis);
                console.log(`Debug: Parsed Lat: ${lat}, Lon: ${lon}`);
                console.log(`Debug: Displaying issueTime: ${issueTime}`); 
                // ***偵錯訊息結束***

                // 構建更詳細的颱風概況描述
                let typhoonSummary = '';
                if (latestAnalysis) {
                    typhoonSummary += `分析時間: ${issueTime}<br>`;
                    typhoonSummary += `中心位置: 北緯 ${lat.toFixed(2)} 度, 東經 ${lon.toFixed(2)} 度<br>`;
                    if (latestAnalysis.pressure) {
                        typhoonSummary += `中心氣壓: ${latestAnalysis.pressure} 百帕<br>`;
                    }
                    if (latestAnalysis.maxWindSpeed) {
                        typhoonSummary += `近中心最大風速: ${latestAnalysis.maxWindSpeed} 公尺/秒 (${(latestAnalysis.maxWindSpeed * 3.6).toFixed(1)} 公里/小時)<br>`;
                    }
                    if (latestAnalysis.maxGustSpeed) {
                        typhoonSummary += `最大陣風速度: ${latestAnalysis.maxGustSpeed} 公尺/秒 (${(latestAnalysis.maxGustSpeed * 3.6).toFixed(1)} 公里/小時)<br>`;
                    }

                    // 處理風圈半徑
                    if (latestAnalysis.circleOf7Bft && latestAnalysis.circleOf7Bft.radius) {
                        typhoonSummary += `七級風暴風半徑: ${latestAnalysis.circleOf7Bft.radius} 公里<br>`;
                    }
                    if (latestAnalysis.circleOf10Bft && latestAnalysis.circleOf10Bft.radius) {
                        typhoonSummary += `十級風暴風半徑: ${latestAnalysis.circleOf10Bft.radius} 公里<br>`;
                    }

                    // 處理移動預測
                    if (latestAnalysis.movingDirection && latestAnalysis.movingSpeed) {
                        typhoonSummary += `移動方向: ${latestAnalysis.movingDirection}，速度: ${latestAnalysis.movingSpeed} 公里/小時<br>`;
                    } else if (latestAnalysis.movingPrediction && Array.isArray(latestAnalysis.movingPrediction) && latestAnalysis.movingPrediction.length > 0) {
                        const zhPrediction = latestAnalysis.movingPrediction.find(p => p.lang === 'zh-hant');
                        if (zhPrediction && zhPrediction.value) {
                            typhoonSummary += `移動預測: ${zhPrediction.value}<br>`;
                        } else {
                            typhoonSummary += `移動預測: 無詳細資料<br>`;
                        }
                    } else {
                        typhoonSummary += `移動預測: 無資料<br>`;
                    }

                    // 添加其他可能重要的原始數據，但以更簡潔的方式呈現
                    if (latestAnalysis.tau) {
                        typhoonSummary += `預報時效: ${latestAnalysis.tau} 小時<br>`;
                    }
                    if (latestAnalysis.initTime) {
                        typhoonSummary += `初始時間: ${new Date(latestAnalysis.initTime).toLocaleString()}<br>`;
                    }
                } else {
                    typhoonSummary = '無最新分析數據可供概況描述。';
                }


                // 動態生成詳細資訊 HTML
                let detailsHtml = `
                    <h3 class="text-xl font-bold text-blue-700 mb-3">${typhoonName}</h3>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-800 mb-2">颱風概況</h4>
                        <p class="text-gray-700 whitespace-pre-wrap">${typhoonSummary}</p>
                    </div>
                `;
                typhoonDetailsContent.innerHTML = detailsHtml;

                // 更新風場預報地圖的 iframe 來源
                const mapSrc = `${WIND_MAP_BASE_URL}?lat=${lat}&lon=${lon}&zoom=${zoom}`;
                // ***偵錯訊息開始***
                console.log(`Debug: Wind Map URL: ${mapSrc}`);
                // ***偵錯訊息結束***
                windMapIframe.src = mapSrc;
                windMapLoading.classList.remove('hidden'); // 顯示載入提示
                // 確保 iframe 初始是透明的，而不是 display: none
                windMapIframe.classList.remove('wind-map-iframe-visible'); 
                windMapIframe.classList.add('wind-map-iframe-hidden'); 

                // 添加 load 事件監聽器，當地圖載入完成後才顯示
                windMapIframe.onload = () => {
                    windMapLoading.classList.add('hidden'); // 隱藏載入提示
                    windMapIframe.classList.remove('wind-map-iframe-hidden'); // 顯示 iframe (透過 opacity)
                    windMapIframe.classList.add('wind-map-iframe-visible');
                };
            } else {
                // 如果找不到颱風資料，顯示錯誤訊息
                if (typhoonDetailsLoading) { // 增加 null 檢查
                    typhoonDetailsLoading.classList.add('hidden');
                }
                typhoonDetailsContent.innerHTML = `
                    <div class="text-red-500 text-center py-10">
                        找不到颱風 ${typhoonId} 的詳細資訊。
                    </div>
                `;
                // 載入預設地圖
                loadDefaultMap();
            }
        }

        // 渲染颱風列表的函數
        function renderTyphoonList(typhoons) {
            const typhoonListDiv = document.getElementById('typhoon-list');
            const typhoonListLoading = document.getElementById('typhoon-list-loading'); 
            typhoonListDiv.innerHTML = ''; // 清空現有列表

            // 只有當 typhoonListLoading 存在時才操作它的 classList
            if (typhoonListLoading) {
                typhoonListLoading.classList.add('hidden'); // 隱藏載入提示
            }

            console.log("Debug: renderTyphoonList called with typhoons:", typhoons); // 新增偵錯訊息

            if (typhoons && typhoons.length > 0) {
                typhoons.forEach(typhoon => {
                    // 從 API 資料中提取所需資訊 (根據 W-C0034-005 實際結構調整)
                    const typhoonId = `${typhoon.cwaTyphoonName || ''}_${typhoon.cwaTdNo || ''}_${typhoon.cwaTyNo || ''}`.replace(/_+$/, '') || '未知ID'; // 組合 ID
                    const typhoonName = typhoon.cwaTyphoonName || typhoon.typhoonName || '未知颱風';
                    
                    // 獲取最新的分析數據點的時間
                    const latestAnalysis = typhoon.analysisData && typhoon.analysisData.fix && typhoon.analysisData.fix.length > 0
                                           ? typhoon.analysisData.fix[typhoon.analysisData.fix.length - 1]
                                           : null;
                    const issueTime = latestAnalysis ? new Date(latestAnalysis.fixTime).toLocaleString() : '無發布時間';

                    // 將完整的颱風資料儲存起來，方便後續點擊時使用
                    typhoonDataMap.set(typhoonId, typhoon);

                    const typhoonItem = document.createElement('div');
                    typhoonItem.classList.add(
                        'typhoon-item', 'p-3', 'mb-2', 'bg-gray-50', 'hover:bg-blue-100',
                        'rounded-lg', 'cursor-pointer', 'transition', 'duration-200', 'ease-in-out'
                    );
                    typhoonItem.dataset.typhoonId = typhoonId;
                    
                    typhoonItem.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-700">${typhoonName}</h3>
                        <p class="text-sm text-gray-500">最新分析時間: ${issueTime}</p>
                    `;

                    typhoonItem.addEventListener('click', () => {
                        // 移除所有颱風項目的 active 樣式
                        document.querySelectorAll('.typhoon-item').forEach(item => {
                            item.classList.remove('bg-blue-200', 'border-l-4', 'border-blue-500');
                        });
                        // 為當前點擊的颱風項目添加 active 樣式
                        typhoonItem.classList.add('bg-blue-200', 'border-l-4', 'border-blue-500');

                        displayTyphoonDetails(typhoonId);
                    });
                    typhoonListDiv.appendChild(typhoonItem);
                });
                console.log(`Debug: Rendered ${typhoons.length} typhoon items.`); // 新增偵錯訊息
            } else {
                document.getElementById('typhoon-list').innerHTML = `
                    <div class="text-gray-500 text-center py-10">
                        目前無颱風警報資料。
                    </div>
                `;
                console.log("Debug: No typhoon data received or typhoons array is empty."); // 新增偵錯訊息
            }
        }

        // 渲染氣象特報列表的函數
        function renderCWAWarningsList(warnings) {
            const cwaWarningsLoading = document.getElementById('cwa-warnings-loading');
            if (cwaWarningsLoading) {
                cwaWarningsLoading.classList.add('hidden'); // 隱藏載入提示
            }

            // 清空所有分類區塊
            document.getElementById('heavy-rain-warnings').innerHTML = '';
            document.getElementById('dense-fog-warnings').innerHTML = '';
            document.getElementById('high-temp-warnings').innerHTML = '';
            document.getElementById('strong-wind-warnings').innerHTML = '';
            document.getElementById('thunderstorm-warnings').innerHTML = '';

            console.log("Debug: renderCWAWarningsList called with warnings:", warnings); // 新增偵錯訊息

            if (warnings && warnings.length > 0) {
                warnings.forEach(warning => {
                    const title = warning.title || '';
                    const description = warning.description || '';
                    
                    const warningItemHtml = `
                        <div class="p-2 mb-1 bg-white hover:bg-gray-50 rounded-lg transition duration-150 ease-in-out text-sm border border-gray-100">
                            <h4 class="font-semibold text-gray-800">${title}</h4>
                            <p class="text-xs text-gray-500">發布時間: ${new Date(warning.pubDate).toLocaleString()}</p>
                            <p class="text-xs text-gray-600 mt-1 line-clamp-2">${description}</p>
                            ${warning.link ? `<a href="${warning.link}" target="_blank" class="text-blue-500 hover:underline text-xs mt-1 block">查看詳情</a>` : ''}
                        </div>
                    `;

                    // 判斷並添加到對應的分類
                    if ((title.includes("豪雨特報") || title.includes("大雨特報")) && document.getElementById('heavy-rain-warnings')) {
                        document.getElementById('heavy-rain-warnings').innerHTML += warningItemHtml;
                    } else if (title.includes("濃霧特報") && document.getElementById('dense-fog-warnings')) {
                        document.getElementById('dense-fog-warnings').innerHTML += warningItemHtml;
                    } else if (title.includes("高溫特報") && document.getElementById('high-temp-warnings')) {
                        document.getElementById('high-temp-warnings').innerHTML += warningItemHtml;
                    } else if (title.includes("強風特報") && document.getElementById('strong-wind-warnings')) {
                        document.getElementById('strong-wind-warnings').innerHTML += warningItemHtml;
                    } else if (title.includes("大雷雨") && document.getElementById('thunderstorm-warnings')) {
                        document.getElementById('thunderstorm-warnings').innerHTML += warningItemHtml;
                    }
                    // 其他未列出的特報將不會被顯示
                });
                console.log(`Debug: Rendered ${warnings.length} CWA warning items.`); // 新增偵錯訊息
            } else {
                // 如果沒有特報，顯示提示訊息
                const emptyMessage = '<p class="text-xs text-gray-400">目前無相關特報。</p>';
                document.getElementById('heavy-rain-warnings').innerHTML = emptyMessage;
                document.getElementById('dense-fog-warnings').innerHTML = emptyMessage;
                document.getElementById('high-temp-warnings').innerHTML = emptyMessage;
                document.getElementById('strong-wind-warnings').innerHTML = emptyMessage;
                document.getElementById('thunderstorm-warnings').innerHTML = emptyMessage;
                console.log("Debug: No CWA warning data received or warnings array is empty."); // 新增偵錯訊息
            }
        }

        // 從代理伺服器獲取氣象特報資料的函數
        async function fetchCWAWarnings() {
            const cwaWarningsLoading = document.getElementById('cwa-warnings-loading');
            if (cwaWarningsLoading) {
                cwaWarningsLoading.classList.remove('hidden'); // 顯示載入提示
            }

            try {
                // 新增：輸出正在嘗試獲取的 URL，以便偵錯
                console.log('Fetching CWA Warnings from URL:', CWA_WARNINGS_API_URL);

                const response = await fetch(CWA_WARNINGS_API_URL, {
                    method: 'GET',
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`CWA Warnings API HTTP 錯誤! 狀態碼: ${response.status}, 回應內容: ${errorText}`);
                    throw new Error(`CWA Warnings API HTTP 錯誤! 狀態碼: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && Array.isArray(data.warnings)) {
                    renderCWAWarningsList(data.warnings);
                } else {
                    console.error('CWA Warnings API 回應資料結構不符預期:', data);
                    document.getElementById('cwa-warnings-list').innerHTML = `
                        <div class="text-red-500 text-center py-10">
                            無法解析氣象特報資料，請檢查 API 回應結構。
                        </div>
                    `;
                }
            } catch (error) {
                console.error('獲取氣象特報資料失敗:', error);
                document.getElementById('cwa-warnings-list').innerHTML = `
                    <div class="text-red-500 text-center py-10">
                        載入氣象特報資料失敗。錯誤訊息: ${error.message}
                    </div>
                `;
            } finally {
                if (cwaWarningsLoading) {
                    cwaWarningsLoading.classList.add('hidden'); // 隱藏載入提示
                }
            }
        }


        // 從代理伺服器獲取颱風資料的函數
        async function fetchTyphoonData() {
            const typhoonListLoading = document.getElementById('typhoon-list-loading');
            // 只有當 typhoonListLoading 存在時才操作它的 classList
            if (typhoonListLoading) {
                typhoonListLoading.classList.remove('hidden'); // 顯示載入提示
            }

            try {
                // 向您部署的代理伺服器發送請求，不再傳遞 API Key
                const response = await fetch(CWA_TYPHOON_API_URL, {
                    method: 'GET',
                });

                // 輸出完整的 Response 物件到控制台，以便偵錯
                console.log('Proxy API Response Object:', response);

                if (!response.ok) {
                    // 如果 HTTP 狀態碼不是 2xx，拋出錯誤
                    const errorText = await response.text(); // 嘗試讀取錯誤訊息
                    console.error(`Proxy HTTP 錯誤! 狀態碼: ${response.status}, 狀態文字: ${response.statusText}, 回應內容: ${errorText}`);
                    throw new Error(`Proxy HTTP 錯誤! 狀態碼: ${response.status}, 訊息: ${response.statusText || '未知錯誤'}`);
                }

                const data = await response.json();
                console.log("Debug: Received CWA typhoon data:", data); // 新增偵錯訊息

                // 檢查 API 回應資料結構
                let typhoons = [];
                if (data.records && data.records.tropicalCyclones && Array.isArray(data.records.tropicalCyclones.tropicalCyclone)) {
                    typhoons = data.records.tropicalCyclones.tropicalCyclone;
                } else {
                    // 如果不是預期的結構，記錄錯誤並顯示訊息
                    console.error('API 回應資料結構不符預期 (W-C0034-005):', data);
                    document.getElementById('typhoon-list').innerHTML = `
                        <div class="text-red-500 text-center py-10">
                            無法解析颱風資料，請檢查 API 回應結構。
                        </div>
                    `;
                    return; // 停止執行
                }

                if (typhoons.length > 0) {
                    renderTyphoonList(typhoons);
                } else {
                    document.getElementById('typhoon-list').innerHTML = `
                        <div class="text-gray-500 text-center py-10">
                            目前無颱風警報資料。
                        </div>
                    `;
                }

            } catch (error) {
                console.error('獲取颱風資料失敗:', error); // 輸出完整的錯誤物件
                let errorMessage = '載入颱風資料失敗。';
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    errorMessage += '可能是網路連線問題，或您的代理伺服器無法存取。';
                } else {
                    errorMessage += `錯誤訊息: ${error.message}。請檢查代理伺服器狀態。`;
                }
                document.getElementById('typhoon-list').innerHTML = `
                    <div class="text-red-500 text-center py-10">
                        ${errorMessage}
                    </div>
                `;
            } finally {
                // 只有當 typhoonListLoading 為 null 時才操作它的 classList
                if (typhoonListLoading) {
                    typhoonListLoading.classList.add('hidden'); // 無論成功或失敗都隱藏載入提示
                }
            }
        }

        // 初始化國際颱風地圖
        function initializeInternationalTyphoonMap() {
            const mapContainer = document.getElementById('custom-typhoon-map');
            const mapLoading = document.getElementById('custom-typhoon-map-loading');

            // 確保地圖容器有正確的尺寸
            if (mapContainer && mapContainer.offsetWidth === 0) {
                console.warn("custom-typhoon-map 容器沒有寬度，可能無法正確初始化地圖。");
            }

            if (internationalTyphoonMap) {
                internationalTyphoonMap.remove(); // 如果地圖已經存在，先移除
            }

            // 初始化 Leaflet 地圖
            internationalTyphoonMap = L.map('custom-typhoon-map', {
                center: [23.5, 121], // 預設台灣中心
                zoom: 4, // 預設縮放級別
                zoomControl: false // 禁用預設的縮放按鈕
            });

            // 添加 OpenStreetMap 圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(internationalTyphoonMap);

            // 顯示載入提示
            if (mapLoading) {
                mapLoading.classList.remove('hidden');
            }

            // 獲取並繪製颱風路徑
            fetchInternationalTyphoonData();
        }

        // 獲取國際颱風資料並繪製
        async function fetchInternationalTyphoonData() {
            const mapLoading = document.getElementById('custom-typhoon-map-loading');
            if (mapLoading) {
                mapLoading.classList.remove('hidden');
            }

            // 清除舊的路徑圖層
            pathLayers.forEach(layer => {
                if (internationalTyphoonMap && internationalTyphoonMap.hasLayer(layer)) {
                    internationalTyphoonMap.removeLayer(layer);
                }
            });
            pathLayers = [];

            try {
                console.log('Fetching international typhoon data from:', INTERNATIONAL_TYPHOON_API_URL);
                const response = await fetch(INTERNATIONAL_TYPHOON_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log("Debug: Received International typhoon data:", data); // 新增偵錯訊息

                // 這裡的邏輯需要調整，因為 api.py 現在返回的是 { success: true, typhoonPaths: [...] }
                if (data.success && data.typhoonPaths && Array.isArray(data.typhoonPaths)) {
                    console.log('Received international typhoon data (NSTC KML format):', data.typhoonPaths);
                    drawAllTyphoonPaths(data.typhoonPaths); // 調用繪製所有颱風路徑的函數
                } else {
                    console.error('Failed to get international typhoon data:', data.message || 'Unknown error');
                    if (internationalTyphoonMap) {
                        L.marker([23.5, 121]).addTo(internationalTyphoonMap)
                         .bindPopup('無法載入國際颱風路徑資料。').openPopup();
                    }
                    const internationalTyphoonStatusDiv = document.getElementById('custom-typhoon-map-loading');
                    if (internationalTyphoonStatusDiv) internationalTyphoonStatusDiv.innerHTML = `<span style="color: red;">${data.message || '無法載入國際颱風路徑資料。'}</span>`;
                }
            } catch (error) {
                console.error('Error fetching international typhoon data:', error);
                if (internationalTyphoonMap) {
                    L.marker([23.5, 121]).addTo(internationalTyphoonMap)
                     .bindPopup(`載入國際颱風路徑失敗: ${error.message}`).openPopup();
                }
                const internationalTyphoonStatusDiv = document.getElementById('custom-typhoon-map-loading');
                if (internationalTyphoonStatusDiv) internationalTyphoonStatusDiv.innerHTML = `<span style="color: red;">載入國際颱風路徑失敗: ${error.message}</span>`;
            } finally {
                if (mapLoading) {
                    mapLoading.classList.add('hidden'); // 隱藏載入提示
                }
            }
        }

        // 繪製所有颱風路徑 (處理 KML 解析後的多個颱風路徑)
        function drawAllTyphoonPaths(typhoonPaths) {
            if (!internationalTyphoonMap) {
                console.error("地圖尚未初始化。");
                return;
            }

            let allCoords = []; // 用於調整地圖視圖

            typhoonPaths.forEach(typhoonPath => {
                const result = drawSingleTyphoonPath(typhoonPath); // 呼叫繪製單個 KML 路徑的函數
                allCoords = allCoords.concat(result.allCoords); // 收集所有座標
            });

            // 調整地圖視圖以包含所有路徑
            if (allCoords.length > 0) {
                internationalTyphoonMap.fitBounds(L.polyline(allCoords).getBounds());
            } else {
                console.log("No typhoon paths to fit map bounds to.");
            }
        }

        // 繪製單個颱風路徑 (根據 NSTC KML 解析後的數據結構)
        function drawSingleTyphoonPath(typhoonPathData) {
            if (!internationalTyphoonMap) {
                console.error("地圖尚未初始化。");
                return { layers: [], allCoords: [] };
            }

            console.log("Debug: Drawing single typhoon path for:", typhoonPathData.name);
            
            const pathLayersForTyphoon = [];
            const allCoordsForTyphoon = [];

            const pathCoords = typhoonPathData.path.map(p => [p.lat, p.lon]);
            
            if (pathCoords.length > 0) {
                const pathColor = getRandomColor(); // 隨機顏色，讓不同路徑區分開
                const polyline = L.polyline(pathCoords, {color: pathColor, weight: 3}).addTo(internationalTyphoonMap);
                pathLayersForTyphoon.push(polyline);
                allCoordsForTyphoon.push(...pathCoords);
                
                // 為每個路徑點添加標記和彈出視窗
                pathCoords.forEach(coord => {
                    const marker = L.circleMarker(coord, {
                        radius: 4,
                        fillColor: pathColor,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(internationalTyphoonMap);
                    pathLayersForTyphoon.push(marker);
                    marker.bindPopup(`<b>${typhoonPathData.name}</b><br>緯度: ${coord[0].toFixed(2)}, 經度: ${coord[1].toFixed(2)}`);
                });
                console.log(`Debug: Drawn ${pathCoords.length} points for ${typhoonPathData.name}.`);
            } else {
                console.log(`Debug: No valid points to draw for ${typhoonPathData.name}.`);
            }
            return { layers: pathLayersForTyphoon, allCoords: allCoordsForTyphoon };
        }

        // 輔助函數：生成隨機顏色
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Add a global counter for Leaflet initialization retries
        let leafletRetryCount = 0;
        const MAX_LEAFLET_RETRIES = 50; // Max 5 seconds of retries (50 * 100ms)

        // 網頁載入完成後執行
        function tryInitializeLeafletMap() {
            if (typeof L !== 'undefined') {
                console.log("Leaflet is defined. Initializing maps and fetching data.");
                loadDefaultMap(); // 初始載入預設地圖 (台灣周邊)
                fetchTyphoonData(); // 首次獲取中央氣象署颱風資料
                fetchCWAWarnings(); // 首次獲取氣象特報資料
                initializeInternationalTyphoonMap(); // 初始化並載入國際颱風地圖

                // 每 10 秒自動獲取最新颱風資料和氣象特報
                setInterval(fetchTyphoonData, 10000); // 10000 毫秒 = 10 秒
                setInterval(fetchCWAWarnings, 10000); // 10000 毫秒 = 10 秒
                // 每 30 秒更新國際颱風地圖 (可以調整頻率)
                setInterval(fetchInternationalTyphoonData, 30000); 
            } else {
                leafletRetryCount++;
                if (leafletRetryCount < MAX_LEAFLET_RETRIES) {
                    console.log(`Leaflet is not yet defined, retrying initialization in 100ms... (Attempt ${leafletRetryCount}/${MAX_LEAFLET_RETRIES})`);
                    setTimeout(tryInitializeLeafletMap, 100);
                } else {
                    console.error("Leaflet failed to load after multiple attempts. Map initialization aborted.");
                    // Display error messages on the map containers
                    document.getElementById('custom-typhoon-map').innerHTML = '<p class="text-center text-red-500 mt-4">地圖載入失敗，請檢查網路連線或瀏覽器擴充功能。</p>';
                    // Also update the status divs (assuming they exist and are accessible)
                    const internationalTyphoonStatusDiv = document.getElementById('custom-typhoon-map-loading'); // Use the loading div for international map
                    if (internationalTyphoonStatusDiv) internationalTyphoonStatusDiv.innerHTML = '<span style="color: red;">地圖載入失敗：Leaflet 函式庫無法載入。</span>';
                }
            }
        }
        // 直接呼叫初始化函數，它會處理載入和重試邏輯
        console.log("Script block loaded. Starting Leaflet initialization check.");
        tryInitializeLeafletMap();
    </script>
</body>
</html>
